# Data set generated by "Capstone_ngram_generator.R"

# Read files
words_start <- readRDS("words_start.RDS")
freq2 <- readRDS("freq2.RDS")
freq3 <- readRDS("freq3.RDS")
freq4 <- readRDS("freq4.RDS")


## Prediction functions
show_prediction <- function(vector, n = 1) {
        if(n == 1)
                return(vector[1])
        else if(n == 2)
                return(vector[2])
        else if(n== 3)
                return(vector[3])
}


predict <- function(text_input, ngrams) {
        
        # For word sequences longer than 3 words: ngrams = 4    
        if(ngrams > 3) {  
                #1 exact match
                text_input_limit3 <- paste(text_input[length(text_input)-2], text_input[length(text_input)-1], text_input[length(text_input)])
                data_tokens <- freq4 %>% filter(variable == text_input_limit3)
                if(nrow(data_tokens) >= 1) {
                        return(data_tokens$outcome[1:3])
                }
                #3 go to 3 grams 
                return(predict(text_input, ngrams - 1))
        }
        
        # For word sequences of 3 words: ngrams = 3 
        if(ngrams == 3) {
                text_input_limited <- paste(text_input[length(text_input)-1], text_input[length(text_input)])
                data_tokens <- freq3 %>% filter(variable == text_input_limited)
                if(nrow(data_tokens) >= 1) {
                        return(data_tokens$outcome[1:3])
                }
                # go to 2 grams
                return(predict(text_input, ngrams - 1))
        }
        
        # For word sequences shorter than 3 words: ngrams = 2 
        if(ngrams < 3) {
                text_input_limited <- text_input[length(text_input)]
                data_tokens <- freq2 %>% filter(variable == text_input_limited)
                return(data_tokens$outcome[1:3])
        }
        return(NA)
}

# Clean input words

clean_input <- function(input) {
        if(input == "" | is.na(input))
                return("")
        # convert to lower case
        input <- tolower(input)
        # remove ordinal numbers
        input <- gsub("[0-9](?:st|nd|rd|th)", "", input, ignore.case=F, perl=T) 
        # remove punctuation
        input <- gsub("[.\\-!]", " ", input, ignore.case=F, perl=T) 
        input <- gsub("[^\\p{L}'\\s]+", "", input, ignore.case=F, perl=T) 
        # trim leading and trailing whitespace
        input <- gsub("^\\s+|\\s+$", "", input)
        input <- stripWhitespace(input)
        if(input == "" | is.na(input))
                return("")
        input <- unlist(strsplit(input, " "))
        return(input)
}

main2 <- function(input, word = 0) {
        
        input <- clean_input(input)
        
        if(input[1] == "") {
                output <- words_start
        }
        
        else if(length(input) == 1) {
                output <- predict(input, ngrams = 2)  
        }
        
        else if(length(input) == 2) {
                output <- predict(input, ngrams = 3)
        }
        
        else if(length(input) > 2) {
                output <- predict(input, ngrams = 4)
        }
        
        
        if (word == 0)
                return(output)
        else if (word == 1)
                return(output[1])
        else if (word == 2)
                return(output[2])
        else if (word == 3)
                return(output[3])
}



# Shiny Server Control
shinyServer(function(input, output) {
        
         # Output Control
        
        output$predictor1 <- reactive({main2(input$text_input, 1)})
        output$predictor2 <- reactive({main2(input$text_input, 2)})
        output$predictor3 <- reactive({main2(input$text_input, 3)})
        
          
})





